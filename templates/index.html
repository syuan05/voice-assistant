<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>語音急救助手</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background-color: #f5f5f5; }
    #chatbox { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    .msg { margin: 10px 0; padding: 10px; border-radius: 8px; max-width: 80%; }
    .user { background: #dcf8c6; align-self: flex-end; text-align: right; margin-left: auto; }
    .ai { background: #e8e8e8; align-self: flex-start; }
    #chat { display: flex; flex-direction: column; }
    #micBtn { margin-top: 20px; }
  </style>
</head>
<body>
  <div id="chatbox">
    <h2>🩺 語音急救助手</h2>
    <div id="chat"></div>
    <button id="micBtn" onclick="startListening()">🎤 開始說話</button>
  </div>

  <script>
    const synth = window.speechSynthesis;
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'zh-TW';

    const chat = document.getElementById("chat");

    // 輸出訊息
    function appendMessage(text, sender) {
      const msg = document.createElement("div");
      msg.className = "msg " + sender;
      msg.textContent = text;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    // 講話時停止播放聲音，開始辨識
    function startListening() {
      synth.cancel(); // ⛔ 停止 AI 講話
      recognition.start();
      appendMessage("（正在聽你說話...）", "user");
    }

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      document.querySelector(".user:last-child").textContent = transcript;
      sendToServer(transcript);
    };

    function sendToServer(text) {
      fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      })
      .then(res => res.json())
      .then(data => {
        const reply = data.response;
        appendMessage(reply, "ai");
        speak(reply);
      })
      .catch(err => {
        appendMessage("⚠️ 發生錯誤，無法取得回應。", "ai");
      });
    }

    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'zh-TW';

      // ✅ 選擇繁體中文語音（若有）
      const voice = synth.getVoices().find(v => v.lang === 'zh-TW');
      if (voice) utter.voice = voice;

      synth.speak(utter);
    }

    // 主動歡迎詞（需等語音載入）
    window.onload = () => {
      synth.onvoiceschanged = () => {
        const welcome = "我是急救助手，請問現在發生什麼情況？";
        appendMessage(welcome, "ai");
        speak(welcome);
      };
    };
  </script>
</body>
</html>
